{{ define "main" }}
<article>
    <div class="container" style="margin-top: 30px;">
        <div class="row">
            <!-- Left Column - Content -->
            <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <div class="content-sidebar">
                    <!-- Property Header -->
                    <header class="property-header">
                        <h1>{{ .Title }}</h1>

                        <!-- Property Quick Facts -->
                        <div class="property-quick-facts">
                            <div class="quick-fact">
                                <i class="fas fa-bed"></i>
                                <span>{{ .Params.bedrooms }} Bedroom{{ if ne .Params.bedrooms 1 }}s{{ end }}</span>
                            </div>
                            <div class="quick-fact">
                                <i class="fas fa-bath"></i>
                                <span>{{ .Params.bathrooms }} Bathroom{{ if ne .Params.bathrooms 1 }}s{{ end }}</span>
                            </div>
                            <div class="quick-fact">
                                <i class="fas fa-users"></i>
                                <span>Sleeps {{ .Params.sleeps }}</span>
                            </div>
                            {{ if .Params.pets }}
                            <div class="quick-fact">
                                <i class="fas fa-paw"></i>
                                <span>Pet Friendly</span>
                            </div>
                            {{ end }}
                            {{ if .Params.wheelchair_accessible }}
                            <div class="quick-fact">
                                <i class="fas fa-universal-access"></i>
                                <span>Wheelchair Accessible</span>
                            </div>
                            {{ end }}
                        </div>
                    </header>

                    <!-- Property Content -->
                    <div class="property-content">
                        {{ .Content }}
                    </div>

                    <!-- Back to Accommodation -->
                    <div class="back-link">
                        <a href="{{ "accommodation" | relURL }}" class="btn-back">
                            <i class="fas fa-arrow-left"></i> Back to All Properties
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right Column - Gallery & Booking -->
            <div class="col-lg-8 col-md-8 col-sm-12 col-xs-12">
                <!-- Image Gallery Carousel -->
                {{ with .Params.gallery_images }}
                <div class="property-gallery-carousel">
                    <div class="carousel-container">
                        <div class="carousel-images">
                            {{ range $index, $imagePath := . }}
                            <div class="carousel-slide {{ if eq $index 0 }}active{{ end }}">
                                <img src="{{ $imagePath | relURL }}" alt="{{ $.Title }} - Image {{ add $index 1 }}" loading="lazy" />
                            </div>
                            {{ end }}
                        </div>
                        <button class="carousel-btn prev" onclick="changeSlide(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="carousel-btn next" onclick="changeSlide(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="carousel-dots">
                            {{ range $index, $imagePath := . }}
                            <span class="dot {{ if eq $index 0 }}active{{ end }}" onclick="goToSlide({{ $index }})"></span>
                            {{ end }}
                        </div>
                    </div>
                </div>
                {{ end }}

                <!-- Booking Section -->
                <div class="booking-section">
                    <h2 class="booking-section-title">Check Availability & Book</h2>
                    <div class="booking-calendar" data-property="{{ .Title | urlize }}">
                        <div id="calendar-{{ .Title | urlize }}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</article>

<!-- Load PhotoSwipe for galleries -->
<link rel="stylesheet" href="/css/hugo-easy-gallery.min.css" />
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css" crossorigin="anonymous" />
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" crossorigin="anonymous"></script>

<!-- Property Page Styling -->
<style>
/* Content Sidebar */
.content-sidebar {
    position: sticky;
    top: 20px;
    padding-right: 30px;
}

.property-header {
    margin-bottom: 30px;
}

.property-header h1 {
    color: #4a6548;
    font-size: 36px;
    font-weight: 400;
    margin-bottom: 25px;
    letter-spacing: -0.5px;
    font-family: Georgia, 'Times New Roman', serif;
}

/* Property Quick Facts */
.property-quick-facts {
    background: #e8e2db;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #8b9e7d;
}

.quick-fact {
    display: flex;
    align-items: center;
    padding: 8px 0;
    color: #3d3935;
    font-size: 15px;
}

.quick-fact i {
    color: #8b9e7d;
    font-size: 18px;
    width: 30px;
    margin-right: 10px;
}

.quick-fact span {
    font-weight: 300;
    letter-spacing: 0.3px;
}

/* Property Content */
.property-content {
    margin-top: 30px;
    color: #555;
    line-height: 1.8;
}

.property-content h2 {
    color: #4a6548;
    font-size: 28px;
    font-weight: 400;
    margin-top: 35px;
    margin-bottom: 20px;
    letter-spacing: -0.5px;
    font-family: Georgia, 'Times New Roman', serif;
}

.property-content h3 {
    color: #4a6548;
    font-size: 20px;
    font-weight: 400;
    margin-top: 25px;
    margin-bottom: 15px;
    font-family: Georgia, 'Times New Roman', serif;
}

.property-content ul,
.property-content ol {
    margin-left: 20px;
    line-height: 1.8;
}

.property-content li {
    margin-bottom: 8px;
}

/* Hide duplicate sections from markdown content */
.property-content h3:has(+ p + .booking-calendar),
.property-content h3:has(+ .booking-calendar) {
    display: none;
}

.property-content .booking-calendar {
    display: none;
}

.property-content p:has(+ .booking-calendar) {
    display: none;
}

/* Back Link */
.back-link {
    margin-top: 40px;
    padding-top: 30px;
    border-top: 1px solid #d9d3cb;
}

.btn-back {
    display: inline-block;
    padding: 12px 24px;
    background: #8b9e7d;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 300;
    letter-spacing: 0.5px;
}

.btn-back:hover {
    background: #6b7d5f;
    transform: translateY(-1px);
    color: white;
}

.btn-back i {
    margin-right: 8px;
}

/* Image Gallery Carousel */
.property-gallery-carousel {
    margin-bottom: 30px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 15px rgba(0,0,0,0.15);
}

.carousel-container {
    position: relative;
    width: 100%;
    background: #000;
}

.carousel-images {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 10;
}

.carousel-slide {
    display: none;
    width: 100%;
    height: 100%;
}

.carousel-slide.active {
    display: block;
}

.carousel-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(139, 158, 125, 0.8);
    color: white;
    border: none;
    padding: 15px 12px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s ease;
    z-index: 10;
    border-radius: 4px;
}

.carousel-btn:hover {
    background: rgba(139, 158, 125, 1);
}

.carousel-btn.prev {
    left: 15px;
}

.carousel-btn.next {
    right: 15px;
}

.carousel-dots {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 10;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
}

.dot.active,
.dot:hover {
    background: rgba(139, 158, 125, 1);
    transform: scale(1.2);
}

/* Booking Section */
.booking-section {
    position: sticky;
    top: 20px;
}

.booking-section-title {
    color: #4a6548;
    font-size: 32px;
    font-weight: 400;
    margin-bottom: 25px;
    letter-spacing: -0.5px;
    font-family: Georgia, 'Times New Roman', serif;
}

/* Booking Calendar */
.booking-calendar {
    background: #e8e2db;
    padding: 30px;
    border-radius: 12px;
    border-left: 4px solid #8b9e7d;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.calendar-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #8b9e7d;
}

.calendar-header h4 {
    margin: 0;
    color: #4a6548;
    font-family: Georgia, 'Times New Roman', serif;
    font-weight: 400;
    font-size: 22px;
}

.calendar-nav button {
    background: #8b9e7d;
    color: white;
    border: none;
    padding: 8px 16px;
    margin: 0 5px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s ease;
}

.calendar-nav button:hover {
    background: #6b7d5f;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    background: white;
    font-size: 14px;
}

.calendar-day.header {
    background: #8b9e7d;
    color: white;
    font-weight: bold;
    cursor: default;
    border: none;
}

.calendar-day.empty {
    background: transparent;
    border: none;
    cursor: default;
}

.calendar-day.past {
    background: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.calendar-day.available {
    background: #f0f5ed;
    border-color: #8b9e7d;
}

.calendar-day.available:hover {
    background: #e3ebe0;
}

.calendar-day.booked {
    background: #ffebee;
    border-color: #f44336;
    cursor: not-allowed;
}

.calendar-day.selected {
    background: #8b9e7d;
    color: white;
    border-color: #8b9e7d;
}

.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #ddd;
}

.booking-form {
    background: white;
    padding: 20px;
    border-radius: 4px;
    margin-top: 20px;
}

.booking-form h4 {
    margin-top: 0;
    color: #4a6548;
    font-family: Georgia, 'Times New Roman', serif;
    font-weight: 400;
    font-size: 22px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 400;
    color: #3d3935;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d9d3cb;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #8b9e7d;
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.selected-dates {
    background: #f0f5ed;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 15px;
    border-left: 3px solid #8b9e7d;
}

.selected-dates p {
    margin: 5px 0;
    color: #3d3935;
}

.btn-submit {
    background: #8b9e7d;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s ease;
    font-weight: 300;
    letter-spacing: 0.5px;
}

.btn-submit:hover {
    background: #6b7d5f;
}

.btn-submit:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 992px) {
    .content-sidebar {
        position: static;
        padding-right: 0;
        margin-bottom: 30px;
    }

    .booking-section {
        position: static;
    }

    .property-header h1 {
        font-size: 28px;
    }

    .booking-section-title {
        font-size: 28px;
    }
}

@media (max-width: 768px) {
    .property-header h1 {
        font-size: 24px;
    }

    .booking-section-title {
        font-size: 24px;
    }

    .booking-calendar {
        padding: 20px;
    }

    .calendar-grid {
        gap: 3px;
    }

    .calendar-day {
        font-size: 13px;
    }
}
</style>

<script>
// Image Carousel Functionality
let currentSlideIndex = 0;

function changeSlide(direction) {
    const slides = document.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.dot');

    if (slides.length === 0) return;

    slides[currentSlideIndex].classList.remove('active');
    dots[currentSlideIndex].classList.remove('active');

    currentSlideIndex += direction;

    if (currentSlideIndex >= slides.length) {
        currentSlideIndex = 0;
    } else if (currentSlideIndex < 0) {
        currentSlideIndex = slides.length - 1;
    }

    slides[currentSlideIndex].classList.add('active');
    dots[currentSlideIndex].classList.add('active');
}

function goToSlide(index) {
    const slides = document.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.dot');

    if (slides.length === 0) return;

    slides[currentSlideIndex].classList.remove('active');
    dots[currentSlideIndex].classList.remove('active');

    currentSlideIndex = index;

    slides[currentSlideIndex].classList.add('active');
    dots[currentSlideIndex].classList.add('active');
}

// Keyboard navigation for carousel
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        changeSlide(-1);
    } else if (e.key === 'ArrowRight') {
        changeSlide(1);
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Initialize calendars for all properties on the page
    const calendars = document.querySelectorAll('.booking-calendar');

    calendars.forEach(calendarEl => {
        const propertyName = calendarEl.dataset.property || 'property';
        const calendarId = calendarEl.querySelector('[id^="calendar-"]')?.id;

        if (calendarId) {
            initializeCalendar(calendarId, propertyName);
        }
    });
});

function initializeCalendar(containerId, propertyName) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // Calendar state
    let currentDate = new Date();
    let selectedStartDate = null;
    let selectedEndDate = null;

    // Booked dates per property (2026 bookings from calendar)
    const propertyBookings = {
        'swallow-barn': [
            // Feb 27 + 3 nights
            '2026-02-27', '2026-02-28', '2026-03-01'
        ],
        'the-old-apple-tallet': [
            // Mar 28 - Apr 4 (Bradford)
            '2026-03-28', '2026-03-29', '2026-03-30', '2026-03-31', '2026-04-01', '2026-04-02', '2026-04-03',
            // May 23-30 (Middleditch)
            '2026-05-23', '2026-05-24', '2026-05-25', '2026-05-26', '2026-05-27', '2026-05-28', '2026-05-29',
            // Jun 20-27 (Gulliver/Cox)
            '2026-06-20', '2026-06-21', '2026-06-22', '2026-06-23', '2026-06-24', '2026-06-25', '2026-06-26',
            // Jul 4-11 (Raza)
            '2026-07-04', '2026-07-05', '2026-07-06', '2026-07-07', '2026-07-08', '2026-07-09', '2026-07-10',
            // Aug 1-15 (Mullder - 2 weeks)
            '2026-08-01', '2026-08-02', '2026-08-03', '2026-08-04', '2026-08-05', '2026-08-06', '2026-08-07',
            '2026-08-08', '2026-08-09', '2026-08-10', '2026-08-11', '2026-08-12', '2026-08-13', '2026-08-14'
        ],
        'kingfisher-cottage': [
            // Jun 6-13
            '2026-06-06', '2026-06-07', '2026-06-08', '2026-06-09', '2026-06-10', '2026-06-11', '2026-06-12'
        ],
        'haypole-barn': [
            // May 11 + 2 nights (BottTC)
            '2026-05-11', '2026-05-12', '2026-05-13',
            // Jun 20 - Jul 4 (Lyons - 2 weeks)
            '2026-06-20', '2026-06-21', '2026-06-22', '2026-06-23', '2026-06-24', '2026-06-25', '2026-06-26',
            '2026-06-27', '2026-06-28', '2026-06-29', '2026-06-30', '2026-07-01', '2026-07-02', '2026-07-03',
            // Jul 25 - Aug 1 (Ellwood)
            '2026-07-25', '2026-07-26', '2026-07-27', '2026-07-28', '2026-07-29', '2026-07-30', '2026-07-31',
            // Aug 22-29 (McGeehan)
            '2026-08-22', '2026-08-23', '2026-08-24', '2026-08-25', '2026-08-26', '2026-08-27', '2026-08-28'
        ],
        'sandmartins': [
            // May 23-30 (Allsop)
            '2026-05-23', '2026-05-24', '2026-05-25', '2026-05-26', '2026-05-27', '2026-05-28', '2026-05-29',
            // Aug 8-15 (Musson)
            '2026-08-08', '2026-08-09', '2026-08-10', '2026-08-11', '2026-08-12', '2026-08-13', '2026-08-14',
            // Aug 22-29 (Ellis)
            '2026-08-22', '2026-08-23', '2026-08-24', '2026-08-25', '2026-08-26', '2026-08-27', '2026-08-28',
            // Sep 4 + 5 nights (Nilsen)
            '2026-09-04', '2026-09-05', '2026-09-06', '2026-09-07', '2026-09-08', '2026-09-09'
        ],
        'saffron-cottage': [
            // May 23-30 (Rayner)
            '2026-05-23', '2026-05-24', '2026-05-25', '2026-05-26', '2026-05-27', '2026-05-28', '2026-05-29',
            // Jul 18-25 (Cutts)
            '2026-07-18', '2026-07-19', '2026-07-20', '2026-07-21', '2026-07-22', '2026-07-23', '2026-07-24'
        ]
    };

    // Get property name from container and build bookedDates object
    const propertyName = container.getAttribute('data-property');
    const bookedDates = {};
    if (propertyBookings[propertyName]) {
        propertyBookings[propertyName].forEach(date => {
            bookedDates[date] = true;
        });
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        let html = `
            <div class="calendar-container">
                <div class="calendar-header">
                    <h4>${firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">← Previous</button>
                        <button onclick="changeMonth(1)">Next →</button>
                    </div>
                </div>
                <div class="calendar-grid">
        `;

        // Day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            html += `<div class="calendar-day header">${day}</div>`;
        });

        // Empty cells before first day
        for (let i = 0; i < firstDayOfWeek; i++) {
            html += '<div class="calendar-day empty"></div>';
        }

        // Days of month
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);
            const dateStr = date.toISOString().split('T')[0];
            const isPast = date < today;
            const isBooked = bookedDates[dateStr];
            const isSelected = isDateInRange(date);

            let className = 'calendar-day';
            if (isPast) className += ' past';
            else if (isBooked) className += ' booked';
            else if (isSelected) className += ' selected';
            else className += ' available';

            const onclick = !isPast && !isBooked ? `onclick="selectDate('${dateStr}')"` : '';
            html += `<div class="${className}" ${onclick}>${day}</div>`;
        }

        html += `
                </div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f0f5ed; border-color: #8b9e7d;"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffebee; border-color: #f44336;"></div>
                        <span>Booked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #8b9e7d;"></div>
                        <span>Selected</span>
                    </div>
                </div>
            </div>
        `;

        // Add booking form
        html += renderBookingForm();

        container.innerHTML = html;
    }

    function isDateInRange(date) {
        if (!selectedStartDate) return false;
        const dateTime = date.getTime();
        const startTime = selectedStartDate.getTime();

        if (!selectedEndDate) {
            return dateTime === startTime;
        }

        const endTime = selectedEndDate.getTime();
        return dateTime >= startTime && dateTime <= endTime;
    }

    function renderBookingForm() {
        const startStr = selectedStartDate ? selectedStartDate.toLocaleDateString('en-GB') : '';
        const endStr = selectedEndDate ? selectedEndDate.toLocaleDateString('en-GB') : '';
        const nights = selectedStartDate && selectedEndDate ?
            Math.ceil((selectedEndDate - selectedStartDate) / (1000 * 60 * 60 * 24)) : 0;

        return `
            <div class="booking-form">
                <h4>Request a Booking</h4>
                ${selectedStartDate ? `
                    <div class="selected-dates">
                        <p><strong>Check-in:</strong> ${startStr}</p>
                        ${selectedEndDate ? `
                            <p><strong>Check-out:</strong> ${endStr}</p>
                            <p><strong>Nights:</strong> ${nights}</p>
                        ` : '<p><em>Please select check-out date</em></p>'}
                    </div>
                ` : '<p><em>Please select your dates on the calendar above</em></p>'}

                <form id="booking-form-${propertyName}" onsubmit="submitBooking(event, '${propertyName}')">
                    <input type="hidden" name="property" value="${propertyName}">
                    <input type="hidden" name="checkin" id="checkin-${propertyName}" value="${selectedStartDate ? selectedStartDate.toISOString().split('T')[0] : ''}">
                    <input type="hidden" name="checkout" id="checkout-${propertyName}" value="${selectedEndDate ? selectedEndDate.toISOString().split('T')[0] : ''}">

                    <div class="form-group">
                        <label for="name">Your Name *</label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone">
                    </div>

                    <div class="form-group">
                        <label for="guests">Number of Guests *</label>
                        <input type="number" id="guests" name="guests" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="message">Additional Information</label>
                        <textarea id="message" name="message" placeholder="Any special requests or questions?"></textarea>
                    </div>

                    <button type="submit" class="btn-submit" ${!selectedStartDate || !selectedEndDate ? 'disabled' : ''}>
                        Send Booking Enquiry
                    </button>
                </form>
            </div>
        `;
    }

    // Make functions available globally for this calendar
    window.changeMonth = function(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    };

    window.selectDate = function(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        date.setHours(0, 0, 0, 0);

        if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
            // Start new selection
            selectedStartDate = date;
            selectedEndDate = null;
        } else if (date > selectedStartDate) {
            // Set end date
            selectedEndDate = date;
        } else {
            // User clicked before start date, reset
            selectedStartDate = date;
            selectedEndDate = null;
        }

        renderCalendar();
    };

    window.submitBooking = function(event, property) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);

        // Convert to query parameters for mailto
        const params = {
            property: formData.get('property'),
            checkin: formData.get('checkin'),
            checkout: formData.get('checkout'),
            name: formData.get('name'),
            email: formData.get('email'),
            phone: formData.get('phone') || 'Not provided',
            guests: formData.get('guests'),
            message: formData.get('message') || 'None'
        };

        // Create email body
        const subject = `Booking Enquiry: ${params.property}`;
        const body = `
Booking Enquiry

Property: ${params.property}
Check-in: ${params.checkin}
Check-out: ${params.checkout}

Guest Information:
Name: ${params.name}
Email: ${params.email}
Phone: ${params.phone}
Number of Guests: ${params.guests}

Additional Information:
${params.message}
        `.trim();

        // Open default email client
        // REPLACE 'your-email@example.com' with your actual email
        window.location.href = `mailto:info@waterloofarmholidays.co.uk?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        // You could also submit to a server endpoint:
        // fetch('/api/booking-enquiry', {
        //     method: 'POST',
        //     headers: {'Content-Type': 'application/json'},
        //     body: JSON.stringify(params)
        // }).then(response => {
        //     alert('Booking enquiry sent! We will contact you soon.');
        //     form.reset();
        //     selectedStartDate = null;
        //     selectedEndDate = null;
        //     renderCalendar();
        // });

        return false;
    };

    // Initial render
    renderCalendar();
}
</script>

{{ end }}
